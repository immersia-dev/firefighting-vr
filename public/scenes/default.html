<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Immersia VR — Treinamento de Combate a Incêndio</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <script src="/scripts/lib/aframe-v1.7.1.min.js"></script>
    <script src="/scripts/lib/aframe-extras.min.js"></script>

    <!-- Debug config must load first -->
    <script src="/scripts/components/config/debug-config.js"></script>

    <!-- Core Components -->
    <script src="/scripts/components/core/text-font-setup.js"></script>
    <script src="/scripts/components/core/vr-stats.js"></script>
    <script src="/scripts/components/core/training-state.js"></script>
    <script src="/scripts/components/core/lod-loader.js"></script>

    <!-- UI Helpers (shared by interactive-panels + tutorial-hud) -->
    <script src="/scripts/components/ui/ui-helpers.js"></script>

    <!-- UI Components -->
    <script src="/scripts/components/ui/tutorial-hud.js"></script>
    <script src="/scripts/components/ui/interactive-panels.js"></script>
    <script src="/scripts/components/ui/training-manager.js"></script>

    <!-- Particle Systems -->
    <script src="/scripts/components/particles/fire-system.js"></script>
    <script src="/scripts/components/particles/foam-system.js"></script>
    <script src="/scripts/components/particles/burn-effect.js"></script>

    <!-- Movement Controllers -->
    <script src="/scripts/components/movement/movement-controller.js"></script>
    <script src="/scripts/components/movement/simple-navmesh-constraint.js"></script>

    <!-- Interaction Components -->
    <script src="/scripts/components/interaction/extinguisher-controller.js"></script>

    <!-- Quest 3S Optimizer -->
    <script src="/scripts/components/core/quest-optimizer.js"></script>

    <!-- Scene Management -->
    <script src="/scripts/components/core/scene-manager.js"></script>

    <link rel="stylesheet" href="/scenes/loading.css" />
  </head>

  <body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="immersia-bg">
      <img
        id="loading-logo"
        src="/assets/imgs/Immersia_logo-removebg.png"
        alt="Immersia Logo"
      />
      <div class="loading-spinner"></div>
      <div class="loading-text">Carregando experiência VR...</div>
    </div>

    <script>
      // Hide loading screen when scene is loaded
      document.addEventListener("DOMContentLoaded", function () {
        const scene = document.querySelector("a-scene");
        const loadingScreen = document.getElementById("loading-screen");

        if (scene && loadingScreen) {
          scene.addEventListener("loaded", function () {
            setTimeout(function () {
              loadingScreen.classList.add("fade-out");
              setTimeout(function () {
                loadingScreen.style.display = "none";
              }, 500);
            }, 500);
          });
        }
      });
    </script>
    <a-scene
      renderer="
        antialias: true;
        colorManagement: true;
        foveationLevel: 1;
        highRefreshRate: true;
        multiviewStereo: true;
        precision: highp;
        alpha: false;
        stencil: false;
        sortTransparentObjects: true;
        powerPreference: high-performance;
      "
      background="color: #000000"
      fog="type: exponential; color: #b0c8dc; density: 0.012"
      vr-stats
      quest-optimizer
    >
      <a-assets>
        <a-asset-item
          id="font-msdf"
          src="/assets/fonts/Exo2-Regular-msdf.json"
        ></a-asset-item>
        <img
          id="font-image"
          src="/assets/fonts/Exo2-Regular.png"
          crossorigin="anonymous"
        />
        <!-- sky texture removed — procedural sky via quest-optimizer -->
        <img
          id="foam-texture"
          src="/assets/textures/foam.png"
          crossorigin="anonymous"
        />
        <!-- Extinguisher models -->
        <a-asset-item
          id="model-extintor-body"
          src="/assets/models/fire_extinguisher/body.glb"
        ></a-asset-item>
        <a-asset-item
          id="model-extintor-seal"
          src="/assets/models/fire_extinguisher/seal.glb"
        ></a-asset-item>
        <a-asset-item
          id="model-extintor-full"
          src="/assets/models/fire_extinguisher/full.glb"
        ></a-asset-item>
        <a-asset-item
          id="model-extintor-full-co2"
          src="/assets/models/fire_extinguisher/full_c02.glb"
        ></a-asset-item>
        <!-- Pallet model -->
        <a-asset-item
          id="model-wooden-pallet"
          src="/assets/models/wooden-pallet.glb"
        ></a-asset-item>
        <!-- Oil barrels model -->
        <a-asset-item
          id="model-oil-barrels"
          src="/assets/models/oil_barrels.glb"
        ></a-asset-item>
        <!-- Table model -->
        <a-asset-item
          id="model-table"
          src="/assets/models/table.glb"
        ></a-asset-item>
        <!-- Plant model -->
        <a-asset-item
          id="model-plant"
          src="/assets/models/plant.glb"
        ></a-asset-item>
      </a-assets>

      <!-- VR Rig -->
      <a-entity
        id="rig"
        position="2 0 -24"
        rotation=" 0 180 0"
        movement-controller="mode: analog; enabled: false"
        movement-controls="speed: 0.15"
        simple-navmesh-constraint="navmesh: .navmesh; fall: 0.5; height: 1.6"
      >
        <a-entity id="camera" camera look-controls position="0 1.6 0"></a-entity>

        <!-- VR Controllers with raycaster for interaction -->
        <a-entity
          id="right-hand-controller"
          laser-controls="hand: right"
          raycaster="enabled: true; objects: .interactable; far: 10; showLine: true"
          line="color: #ffffff; opacity: 0.95"
        >
          <!-- Hand-attached extinguisher (hidden until grabbed) -->
          <a-entity
            id="extinguisher-hand"
            visible="false"
            position="0 -0.3 0.1"
            rotation="-38 0 0"
          >
            <a-entity
              id="extintor-hand-body"
              gltf-model="#model-extintor-body"
              scale="1 1 1"
            >
              <!-- Anchor: where the hose connects to the body.
                   Adjust position in Inspector to match nozzle outlet. -->
              <a-entity id="hose-anchor" position="-0.05 0.32 0.0"></a-entity>
            </a-entity>
            <a-entity
              id="extintor-hand-seal"
              gltf-model="#model-extintor-seal"
              position="-0.005 0.010 -0.13"
            ></a-entity>
            <!-- GLTF hose commented out — dynamic spline hose by extinguisher-controller -->
            <!--
            <a-entity
              gltf-model="#model-extintor-hose"
              position="0 0.05 0.08"
            ></a-entity>
            -->
          </a-entity>
        </a-entity>

        <a-entity
          id="left-hand-controller"
          laser-controls="hand: left"
          raycaster="enabled: true; objects: .interactable; far: 10; showLine: true"
          line="color: #ffffff; opacity: 0.4"
        >
          <!-- Foam nozzle: child of left controller for Inspector convenience.
               Position is a static offset relative to the hand.
               Rotation is overridden each frame by extinguisher-controller
               to follow the spline tip tangent direction. -->
          <a-entity
            id="foam-nozzle"
            position="0.015 -0.065 -0.095"
            foam-system="autoStart: false; texture: #foam-texture; rate: 180; speed: 8; coneAngle: 6; sizeStart: 0.1; sizeEnd: 0.8; maxParticles: 800; life: 2.0; gravity: -4; drag: 1.2; opacity: 0.65; floorY: 0; groundSpread: 2; groundDrag: 6; groundBounce: 0.03; groundSizeScale: 1.5; turbulence: 0.8; spreadGrowth: 1.5"
          ></a-entity>
        </a-entity>

        <!-- Tutorial HUD (non-interactive messages) -->
        <a-entity id="tutorial-hud" tutorial-hud="enabled: true"></a-entity>

        <!-- Interactive Panels (with movement lock) -->
        <a-entity
          id="interactive-panels"
          interactive-panels="enabled: true"
        ></a-entity>

        <!-- Training Manager (orchestrates everything) -->
        <a-entity
          id="training-manager"
          training-manager="enabled: true"
        ></a-entity>
      </a-entity>

      <!-- Simple training environment (placeholder until optimized hangar is ready) -->
      <a-entity id="training-environment">
        <!-- Navmesh - defines walkable area -->
        <a-plane
          id="navmesh"
          position="1 0.1 -20.3"
          rotation="-90 0 0"
          width="17"
          height="14"
          visible="false"
          class="navmesh"
        ></a-plane>

        <!-- Plant (visual) -->
        <a-entity
          id="plant"
          gltf-model="#model-plant"
          rotation="0 0 0"
          position="0 0 0"
        >
      </a-entity>

      <!-- Extinguisher World Version (visible until grabbed) -->
      <a-entity
        id="extinguisher-world"
        position="6 0.85 -21"
        rotation="0 -90 0"
        scale="1.6 1.6 1.6"

      >
        <!-- Invisible grab collider (larger than model for easy targeting) -->
        <a-box
          id="extinguisher-collider"
          class="interactable"
          width="0.3"
          height="0.5"
          depth="0.1"
          position="0 0.2 0.03"
          material="transparent: false; opacity: 0"
        ></a-box>

        <!-- Visible models -->
        <a-entity
          gltf-model="#model-extintor-full"
          position="0 0 0"
        ></a-entity>
      </a-entity>

      <!-- Extinguisher World Version (visible until grabbed) -->
      <a-entity
        id="extinguisher-world-co2"
        position="6 0.85 -21.5"
        rotation="0 -90 0"
        scale="1.6 1.6 1.6"

      >
        <!-- Invisible grab collider (larger than model for easy targeting) -->
        <a-box
          id="extinguisher-collider-co2"
          class="interactable"
          width="0.3"
          height="0.5"
          depth="0.1"
          position="0 0.2 0.03"
          material="transparent: false; opacity: 0"
        ></a-box>

        <!-- Visible models -->
        <a-entity
          gltf-model="#model-extintor-full-co2"
          position="0 0 0"
        ></a-entity>
      </a-entity>

      <!-- Extinguisher Controller (scene-level orchestrator) -->
      <a-entity
        id="extinguisher-controller"
        extinguisher-controller="enabled: true; gripHand: right; hoseTipLength: 0.075"
      ></a-entity>

      <!-- Burning Box -->
      <a-entity
        id="burning-wooden-pallet"
        position="2 0.01 -18"
        rotation="0 180 0"
        fire-system="
          fireRate: 60;
          smokeRate: 2;
          ceilingSmokeRate: 20;
          fireTexture: /assets/textures/fire.png;
          smokeTexture: /assets/textures/smoke.png;
          radius: 0.5;
          maxLife: 1.8;
          maxSize: 4.0;
          smokeMaxLife: 3.0;
          smokeMaxSize: 4.0;
          ceilingHeight: 5.5;
          ceilingWidth: 14;
          ceilingDepth: 12;
          enableCeiling: true
        "
      >
        <a-entity
          id="wooden-pallet"
          gltf-model="#model-wooden-pallet"
          material="color: #1a0f08; roughness: 0.9; metalness: 0.1; emissive: #0a0503; emissiveIntensity: 0.2"
          burn-effect
        ></a-entity>
      </a-entity>

      <a-entity
        id="oil-barrels"
        gltf-model="#model-oil-barrels"
        position="-3.2 0.075 -18"
        rotation="0 -90 0"
        scale="0.2 0.2 0.2"
      ></a-entity>

        <a-entity
          id="table"
          gltf-model="#model-table"
          position="6 0 -22"
          rotation="0 90 0"
        ></a-entity>

      <!-- burn-effect component loaded from /scripts/components/particles/burn-effect.js -->



      <!-- ═══ Lighting — optimized for Quest 3S standalone ═══ -->

      <!-- Ambient light — low-cost base fill -->
      <a-entity
        light="type: ambient; intensity: 0.45; color: #DCE4F0"
        id="ambient-light"
      ></a-entity>

      <!-- Hemisphere light — sky/ground fill for natural outdoor feel (cheap) -->
      <a-entity
        light="type: hemisphere; intensity: 0.5; color: #87CEEB; groundColor: #8B7355"
        id="hemisphere-light"
      ></a-entity>

      <!-- Sun — single directional, tight shadow frustum, small map -->
      <a-entity
        light="type: directional; intensity: 1.2; color: #FFF4E0;
               castShadow: true;
               shadowMapWidth: 512; shadowMapHeight: 512;
               shadowCameraNear: 0.5; shadowCameraFar: 50;
               shadowCameraLeft: -15; shadowCameraRight: 15;
               shadowCameraTop: 15; shadowCameraBottom: -15;
               shadowBias: -0.001"
        position="8 12 4"
        id="sun-light"
      ></a-entity>

      <!-- Back-fill — subtle cool opposite (no shadow) -->
      <a-entity
        light="type: directional; intensity: 0.25; color: #A0C0E0; castShadow: false"
        position="-5 8 5"
        id="fill-light"
      ></a-entity>

      <!-- Interior fill lights for plant (local only, no shadows) -->
      <a-entity
        id="plant-fill-light-1"
        light="type: point; intensity: 0.5; distance: 12; decay: 2; color: #FFFFFF; castShadow: false"
        position="0 3 -20"
      ></a-entity>
      <a-entity
        id="plant-fill-light-2"
        light="type: point; intensity: 0.35; distance: 10; decay: 2; color: #DDEBFF; castShadow: false"
        position="-4 2.5 -21"
      ></a-entity>

      <!-- Procedural sky via quest-optimizer component (replaces <a-sky>) -->
    </a-scene>
  </body>
</html>
