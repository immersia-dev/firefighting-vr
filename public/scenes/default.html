<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Immersia VR Scene - Vet Anatomy</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <script src="/scripts/lib/aframe-v1.7.1.min.js"></script>
    <script src="/scripts/lib/aframe-extras.min.js"></script>

    <script src="/scripts/components/text-font-setup.js"></script>
    <script src="/scripts/components/particles/fire.js"></script>
    <script src="/scripts/components/particles/foam.js"></script>
    <!-- <script src="/scripts/components/interaction-mode-manager.js"></script>
    <script src="/scripts/components/anatomy-layer-manager.js"></script> -->

    <!-- <script src="/scripts/components/hand-tracking/hand-color-manager.js"></script>
    <script src="/scripts/components/hand-tracking/hand-movable.js"></script>
    <script src="/scripts/components/hand-tracking/hand-rotatable.js"></script>
    <script src="/scripts/components/hand-tracking/hand-scalable.js"></script> -->

    <style>
      body {
        margin: 0;
        overflow: hidden;
      }

      /* Immersia background gradient (radial glows + dark base) */
      .immersia-bg {
        background: radial-gradient(
            900px 520px at 20% 0%,
            rgba(42, 198, 255, 0.2),
            transparent 55%
          ),
          radial-gradient(
            760px 520px at 85% 18%,
            rgba(217, 70, 239, 0.22),
            transparent 58%
          ),
          radial-gradient(
            900px 520px at 60% 100%,
            rgba(124, 58, 237, 0.28),
            transparent 60%
          ),
          linear-gradient(180deg, #070615 0%, #0a0820 45%, #070615 100%);
      }

      #loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        /* Background now provided by .immersia-bg */
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        transition: opacity 0.5s ease-out;
      }

      #loading-screen.fade-out {
        opacity: 0;
        pointer-events: none;
      }

      #loading-logo {
        width: 280px;
        height: auto;
        margin-bottom: 40px;
        animation: pulse 2s ease-in-out infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.8;
          transform: scale(0.98);
        }
      }

      .loading-spinner {
        width: 60px;
        height: 60px;
        border: 4px solid rgba(255, 255, 255, 0.2);
        border-top-color: #a855f7;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .loading-text {
        margin-top: 20px;
        color: #ffffff;
        font-family:
          system-ui,
          -apple-system,
          sans-serif;
        font-size: 16px;
        letter-spacing: 1px;
      }
    </style>
  </head>

  <body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="immersia-bg">
      <img
        id="loading-logo"
        src="/assets/Immersia_logo-removebg.png"
        alt="Immersia Logo"
      />
      <div class="loading-spinner"></div>
      <div class="loading-text">Carregando experiÃªncia VR...</div>
    </div>

    <script>
      // Hide loading screen when scene is loaded
      document.addEventListener("DOMContentLoaded", function () {
        const scene = document.querySelector("a-scene");
        const loadingScreen = document.getElementById("loading-screen");

        if (scene && loadingScreen) {
          scene.addEventListener("loaded", function () {
            setTimeout(function () {
              loadingScreen.classList.add("fade-out");
              setTimeout(function () {
                loadingScreen.style.display = "none";
              }, 500);
            }, 500);
          });
        }
      });
    </script>
    <a-scene renderer="antialias: true" background="color: #376c95">
      <a-assets>
        <a-asset-item
          id="font-msdf"
          src="/assets/fonts/Exo2-Regular-msdf.json"
        ></a-asset-item>
        <img
          id="font-image"
          src="/assets/fonts/Exo2-Regular.png"
          crossorigin="anonymous"
        />
        <img id="sky" src="/assets/sky.jpg" />
        <img id="foam-texture" src="/assets/foam.png" crossorigin="anonymous" />
        <a-asset-item id="model-hangar" src="/assets/hangar.glb"></a-asset-item>
        <a-asset-item
          id="model-wooden-pallet"
          src="/assets/wooden-pallet.glb"
        ></a-asset-item>
      </a-assets>

      <script>
        // Keep rig/camera following the animated nozzle for testing
        AFRAME.registerComponent("follow-nozzle", {
          schema: {
            target: { type: "selector" },
            offset: { type: "vec3", default: { x: 0, y: 0.15, z: 0.6 } },
          },
          init() {
            this.tmpPos = new THREE.Vector3();
            this.tmpQuat = new THREE.Quaternion();
            this.tmpOff = new THREE.Vector3();
          },
          tick() {
            const t = this.data.target;
            if (!t) return;
            t.object3D.getWorldPosition(this.tmpPos);
            t.object3D.getWorldQuaternion(this.tmpQuat);
            this.tmpOff.copy(this.data.offset).applyQuaternion(this.tmpQuat);
            this.tmpPos.add(this.tmpOff);
            this.el.object3D.position.copy(this.tmpPos);
            this.el.object3D.quaternion.copy(this.tmpQuat);
          },
        });
      </script>

      <a-entity
        id="rig"
        position="0 1.6 -7"
        movement-controls="speed: 0.15"
        follow-nozzle="target: #foam-nozzle; offset: 0.35 0.05 0.5"
      >
        <a-entity id="camera" camera look-controls></a-entity>

        <!-- <a-entity
          id="right-hand-tracking"
          hand-tracking-grab-controls="hand: right; modelColor: #ffffff; modelOpacity: 0.9; modelStyle: mesh; hoverColor: #00ff00; hoverEnabled: true; color: #ffffff; enabled: false"
          raycaster="enabled: false; objects: .interactable; far: 10; showLine: false"
          hand-color-manager
        ></a-entity> -->

        <!-- <a-entity
          id="left-hand-tracking"
          hand-tracking-grab-controls="hand: left; modelColor: #ffffff; modelOpacity: 0.9; modelStyle: mesh; hoverColor: #00ff00; hoverEnabled: true; color: #ffffff; enabled: false"
          raycaster="enabled: false; objects: .interactable; far: 10; showLine: false"
          hand-color-manager
        ></a-entity> -->

        <a-entity
          id="right-hand-controller"
          laser-controls="hand: right"
          raycaster="enabled: true; objects: .interactable; far: 10; showLine: true"
          line="color: #ffffff; opacity: 0.95"
        ></a-entity>

        <a-entity
          id="left-hand-controller"
          laser-controls="hand: left"
          raycaster="enabled: true; objects: .interactable; far: 10; showLine: true"
          line="color: #ffffff; opacity: 0.4"
        ></a-entity>
      </a-entity>

      <a-entity id="hangar" gltf-model="#model-hangar"></a-entity>
      <!-- Burning Box -->
      <a-entity
        id="burning-wooden-pallet"
        position="0 0.5 -15"
        fire="
          fireRate: 100;
          smokeRate: 2;
          ceilingSmokeRate: 35;
          fireTexture: /assets/fire.png;
          smokeTexture: /assets/smoke.png;
          radius: 0.5;
          maxLife: 1.8;
          maxSize: 4.5;
          smokeMaxLife: 3.5;
          smokeMaxSize: 5.5;
          ceilingHeight: 5.5;
          ceilingWidth: 18;
          ceilingDepth: 15;
          enableCeiling: true
        "
      >
        <a-entity
          id="wooden-pallet"
          gltf-model="#model-wooden-pallet"
          material="color: #1a0f08; roughness: 0.9; metalness: 0.1; emissive: #0a0503; emissiveIntensity: 0.2"
          burn-effect
        ></a-entity>
      </a-entity>

      <script>
        // Component to darken object as it burns (accumulates over time, does not reverse)
        AFRAME.registerComponent("burn-effect", {
          schema: {
            burnRate: { type: "number", default: 0.08 }, // burn per second while fire is active
            minIntensity: { type: "number", default: 0.2 }, // only burn when fire is meaningfully on
          },
          init() {
            this.initialColor = new THREE.Color(0x1a0f08);
            this.burnedColor = new THREE.Color(0x000000);
            this.initialEmissive = new THREE.Color(0x0a0503);
            this.burnedEmissive = new THREE.Color(0x000000);
            this.burnAmount = 0; // accumulative soot/char
          },
          tick(time, timeDelta) {
            const fire = this.el.parentEl.components.fire;
            if (!fire) return;

            // Accumulate burn over time while fire is above threshold; never brighten back
            if (fire.fireIntensity > this.data.minIntensity) {
              this.burnAmount = Math.min(
                1,
                this.burnAmount + (timeDelta / 1000) * this.data.burnRate,
              );
            }

            // Update material color progressively
            this.el.object3D.traverse((node) => {
              if (node.material) {
                const mat = node.material;
                if (!mat.userData.originalColor) {
                  mat.userData.originalColor = mat.color
                    ? mat.color.clone()
                    : this.initialColor.clone();
                  mat.userData.originalEmissive = mat.emissive
                    ? mat.emissive.clone()
                    : this.initialEmissive.clone();
                }

                if (mat.color) {
                  mat.color
                    .copy(mat.userData.originalColor)
                    .lerp(this.burnedColor, this.burnAmount);
                }
                if (mat.emissive) {
                  mat.emissive
                    .copy(mat.userData.originalEmissive)
                    .lerp(this.burnedEmissive, this.burnAmount);
                }
              }
            });
          },
        });
      </script>

      <!-- Debug foam nozzle to validate component; press "E" to toggle -->
      <a-entity
        id="foam-nozzle"
        position="0 1.5 -10"
        rotation="8 0 0"
        foam="autoStart: false; rate: 280; jetLength: 4; jetRadius: 0.24; speed: 8; spread: 0.22; life: 0.85; sizeMin: 0.10; sizeMax: 0.22; gravity: -4.5; drag: 2.5; foamTexture: /assets/foam.png"
      >
        <a-cylinder
          radius="0.04"
          height="0.35"
          color="#bbbbbb"
          rotation="90 0 0"
        ></a-cylinder>
        <a-sphere radius="0.05" color="#e0e0e0" position="0 0.2 0"></a-sphere>
      </a-entity>

      <!-- Ambient light provides base illumination for the entire scene -->
      <a-entity
        light="type: ambient; intensity: 0.5; color: #BBCCFF"
        id="ambient-light"
      ></a-entity>

      <!-- Main directional light simulating sunlight from skylights -->
      <a-entity
        light="type: directional; intensity: 0.8; castShadow: true; shadowCameraVisible: false"
        position="5 10 2"
        rotation="-45 0 0"
        id="sun-light"
      ></a-entity>

      <!-- Point light for hangar interior depth -->
      <a-entity
        light="type: point; intensity: 0.6; distance: 30; decay: 2; color: #FFFFFF"
        position="-1.7 4.8 -26.5"
        id="point-light-1"
      ></a-entity>

      <!-- Secondary fill light to reduce harsh shadows -->
      <a-entity
        light="type: hemisphere; intensity: 0.4; groundColor: #808080"
        id="hemisphere-light"
      ></a-entity>

      <a-sky src="#sky"></a-sky>
    </a-scene>

    <script>
      // Toggle foam test with "E" until proper extinguisher handling is wired
      document.addEventListener("keydown", (e) => {
        if (e.key.toLowerCase() !== "e") return;
        const nozzle = document.querySelector("#foam-nozzle");
        if (!nozzle || !nozzle.components.foam) return;
        const comp = nozzle.components.foam;
        if (comp.emitting) {
          comp.stop();
        } else {
          comp.start();
        }
      });
    </script>
  </body>
</html>
